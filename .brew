#!/usr/bin/env bash

set -o errexit
set -o pipefail
set -o nounset

DEBUG=${DEBUG:=0}
[[ $DEBUG -eq 1 ]] && set -o xtrace

export HOMEBREW_CASK_OPTS="--appdir=${HOME}/Applications --fontdir=${HOME}/Library/Fonts --no-binaries"
export HOMEBREW_NO_ANALYTICS=1
export HOMEBREW_NO_INSECURE_REDIRECT=1
export PATH="${HOME}/.homebrew/bin:${PATH}"

CPU_BRAND="$(sysctl -n machdep.cpu.brand_string)"
export CPU_BRAND

echo "--> Detected CPU Brand: ${CPU_BRAND}"

# Enforce cpu architecture because alacritty run in x86_64 compatibility mode and bash process inherit.
if [[ $CPU_BRAND == 'Apple M1' ]]; then
  function brew() {
    arch -arm64 brew "$@"
  }
else
  function brew() {
    arch -x86_64 brew "$@"
  }
fi

echo "--> Make sure we're using the latest Homebrew"
brew update

echo '--> Upgrade any already-installed formulae'
brew upgrade

echo '--> Tap extras Homebrew repositories'
brew tap tldr-pages/tldr

echo '--> Install all brew Packages'
brew install \
  1password \
  ack \
  advancecomp \
  ansifilter \
  autoenv \
  awscli \
  bash \
  bash-completion@2 \
  bat \
  bats \
  binutils \
  cheat \
  chruby \
  cli53 \
  closure-compiler \
  coreutils \
  ctags \
  curl \
  diff-so-fancy \
  diffutils \
  ed \
  editorconfig \
  entr \
  fd \
  findutils \
  firefox \
  font-hack \
  font-hack-nerd-font \
  fzf \
  gawk \
  gifsicle \
  git \
  gitlint \
  gnu-indent \
  gnu-sed \
  gnu-sed \
  gnu-tar \
  gnu-tar \
  gnu-which \
  go \
  google-backup-and-sync \
  google-chrome \
  gpatch \
  gpg \
  grep \
  gsl \
  gzip \
  htmlcompressor \
  imageoptim \
  ipcalc \
  iterm2 \
  jhead \
  jpeg \
  jpegoptim \
  jq \
  k9s \
  keybase \
  kops \
  kubectx \
  less \
  lesspipe \
  little-snitch \
  make \
  micro-snitch \
  moreutils \
  nmap \
  omnigraffle \
  openssl \
  optipng \
  pigz \
  pngcrush \
  pngquant \
  pre-commit \
  prettier \
  proselint \
  pv \
  pwgen \
  python@3.9 \
  readline \
  rectangle \
  ruby-build \
  ruby-install \
  s3cmd \
  sequel-pro \
  shfmt \
  shpotify \
  spotify \
  ssh-copy-id \
  starship \
  stow \
  tcpdump \
  terminal-notifier \
  terraform \
  the_silver_searcher \
  tig \
  tldr \
  tmux \
  tor-browser \
  tree \
  vim \
  watch \
  wget \
  xz \
  zoxide

if [[ $CPU_BRAND == 'Apple M1' ]]; then
  # Install incompatibles brew formulas with compatibility mode in an isolated homebrew directory
  arch -x86_64 ~/.homebrew_x86_64/bin/brew update
  arch -x86_64 ~/.homebrew_x86_64/bin/brew upgrade
  arch -x86_64 ~/.homebrew_x86_64/bin/brew install \
    hadolint \
    packer \
    htop-osx \
    shellcheck
else
  brew install \
    hadolint \
    packer \
    htop-osx \
    shellcheck
fi

# Yes, I use a non privileged user for daily use
echo "--> login as admin to install some casks system-wide in /Applications"

su admin -c "
while true; do sudo -n true; sleep 60; kill -0 $$ || exit; done 2>/dev/null &

make -f ${HOME}/.dotfiles/Makefile install-homebrew

export HOMEBREW_CASK_OPTS='--appdir=/Applications --no-binaries'
export PATH='/Users/admin/.homebrew/bin:${PATH}'

echo '--> Install/update Homebrew cask'

brew update

brew tap homebrew/cask-drivers

brew install \
  gpg-suite \
  suunto-moveslink2 \
  vagrant \
  virtualbox
"

## gcloud
mkdir -p "${HOME}/.google-cloud-sdk"
chmod 0700 "${HOME}/.google-cloud-sdk"
if [[ ! -x "${HOME}/.google-cloud-sdk/bin/gcloud" ]]; then
  curl -L https://dl.google.com/dl/cloudsdk/channels/rapid/downloads/google-cloud-sdk-143.0.0-darwin-x86_64.tar.gz |
    tar xz --strip 1 -C ~/.google-cloud-sdk
  "${HOME}/.google-cloud-sdk/install.sh" \
    --usage-reporting false \
    --bash-completion false \
    --path-update false \
    --rc-path false \
    --quiet
fi

## ruby
mkdir -p "${HOME}/.rubies"

RUBIES=(
  2.7.2
)

for ruby in "${RUBIES[@]}"; do
  if [[ ! -f "${HOME}/.rubies/ruby-${ruby}/bin/ruby" ]]; then
    "$(brew --prefix)/bin/ruby-build" "$ruby" "${HOME}/.rubies/ruby-${ruby}"
  fi
done

echo "${RUBIES[@]:(-1)}" >~/.ruby-version

GEMS=(
  puppet-lint
  rubocop
  shell_explain
)

# shellcheck source=/dev/null
source "$(brew --prefix)/share/chruby/chruby.sh"
chruby "$(cat "${HOME}/.ruby-version")"

brew unlink xz

for gem in "${GEMS[@]}"; do
  gem list -i "${gem}" &>/dev/null || gem install "${gem}"
done

gem ctags
for ruby in ~/.rubies/*/lib/ruby/; do
  pushd "${ruby}" &>/dev/null || exit
  ctags -R ./*
  popd &>/dev/null || exit
done

gem pristine --all

brew link xz
