#!/usr/bin/env bash

export HOMEBREW_NO_ANALYTICS=1
export HOMEBREW_NO_INSECURE_REDIRECT=1
export PATH="${HOME}/.homebrew/bin:${PATH}"

trap 'brew prune' INT TERM HUP EXIT

echo "--> Make sure we're using the latest Homebrew"
brew update

echo '--> Upgrade any already-installed formulae'
brew upgrade

echo '--> Tap extras Homebrew repositories'
brew tap caskroom/drivers
brew tap caskroom/fonts
brew tap caskroom/versions
brew tap coinbase/assume-role
brew tap homebrew/cask-drivers
brew tap homebrew/services
brew tap jeffreywildman/homebrew-virt-manager
brew tap thoughtbot/formulae
brew tap tldr-pages/tldr

echo '--> Install all brew Packages'
brew install \
  ack \
  advancecomp \
  ansifilter \
  autoenv \
  awscli \
  bash \
  bash-completion@2 \
  bats \
  binutils \
  cheat \
  chruby \
  cli53 \
  closure-compiler \
  coreutils \
  ctags \
  curl --with-openssl \
  diffutils \
  dnscrypt-proxy \
  ed --with-default-names \
  editorconfig \
  entr \
  fd \
  ffmpeg \
  findutils \
  findutils --with-default-names \
  gawk \
  gnu-indent --with-default-names \
  gnu-sed --with-default-names \
  gnu-tar --with-default-names \
  gnu-which --with-default-names \
  grep --with-default-names \
  gzip \
  fzf \
  gifsicle \
  git \
  gnu-sed --with-default-names \
  gnu-tar \
  go \
  gpatch \
  gpg \
  graphviz \
  gsl \
  hadolint \
  htmlcompressor --yuicompressor \
  htop-osx \
  imagemagick --with-webp \
  ipcalc \
  jhead \
  jpeg \
  jpegoptim \
  jq \
  kops \
  kubectx \
  less \
  lesspipe \
  macvim \
  make --with-default-names \
  moreutils \
  openssl \
  optipng \
  packer \
  pigz \
  pngcrush \
  pngquant \
  pre-commit \
  proselint \
  pv \
  pwgen \
  pyenv \
  pyenv-virtualenv \
  pyenv-virtualenvwrapper \
  readline \
  reattach-to-user-namespace \
  ruby-build \
  ruby-install \
  s3cmd \
  shellcheck \
  shpotify \
  spark \
  ssh-copy-id \
  sshrc \
  stow \
  tcpdump \
  terminal-notifier \
  terraform \
  the_silver_searcher \
  tig \
  tldr \
  tmux \
  tor \
  torsocks \
  tree \
  v \
  virt-manager \
  virt-viewer \
  watch \
  wget \
  xz \
  z

# login as admin to install all casks system-wide in /Applications
su admin -c "
while true; do sudo -n true; sleep 60; kill -0 $$ || exit; done 2>/dev/null &

make -f ${HOME}/.dotfiles/Makefile install-homebrew

export HOMEBREW_CASK_OPTS='--appdir=/Applications --no-binaries'
export PATH='/Users/admin/.homebrew/bin:${PATH}'

echo '--> Install/update Homebrew cask'

brew tap caskroom/cask
brew tap homebrew/cask-fonts

brew update

brew cask install \
  1password \
  firefox \
  flux \
  font-hack \
  font-hack-nerd-font \
  gimp \
  google-chrome \
  google-drive \
  gpgtools \
  imageoptim \
  iterm2 \
  java6 \
  java7 \
  keybase \
  little-snitch \
  micro-snitch \
  movelinks \
  omnigraffle \
  sequel-pro \
  spectacle \
  spotify \
  synology-drive \
  torbrowser \
  tunnelbear \
  vagrant \
  virtualbox \
  vlc \
  xquartz
"

## gcloud
mkdir -p "${HOME}/.google-cloud-sdk"
chmod 0700 "${HOME}/.google-cloud-sdk"
if [[ ! -x "${HOME}/.google-cloud-sdk/bin/gcloud" ]]; then
  curl -L https://dl.google.com/dl/cloudsdk/channels/rapid/downloads/google-cloud-sdk-143.0.0-darwin-x86_64.tar.gz \
    | tar xz --strip 1 -C ~/.google-cloud-sdk
  "${HOME}/.google-cloud-sdk/install.sh" \
    --usage-reporting false \
    --bash-completion false \
    --path-update false \
    --rc-path false \
    --quiet
fi

## python
pyenv install -s 2.7.13
pyenv global 2.7.13

PIPS=(
  fabric
  flake8
  gmvault
  howdoi
  httpie
  jungle
  pylint
  virtualenv
  yamllint
)

"${HOME}/.pyenv/shims/pip" install --upgrade pip

for pip in "${PIPS[@]}"; do
  "${HOME}/.pyenv/shims/pip" list -l | grep "$pip" &>/dev/null || \
    "${HOME}/.pyenv/shims/pip" install "$pip"
done

## ruby
mkdir -p "${HOME}/.rubies"

RUBIES=(
  2.6.0
)

for ruby in "${RUBIES[@]}"; do
  if [[ ! -f "${HOME}/.rubies/ruby-${ruby}/bin/ruby" ]]; then
    "$(brew --prefix)/bin/ruby-build" "$ruby" "${HOME}/.rubies/ruby-${ruby}"
  fi
done

echo "${RUBIES[@]:(-1)}" > ~/.ruby-version

GEMS=(
  bundler
  fasterer
  hue
  kitchen-vagrant
  puppet-lint
  rubocop
  shell_explain
  tmuxinator
)

# shellcheck source=/dev/null
source "$(brew --prefix)/share/chruby/chruby.sh"
chruby "$(cat "${HOME}/.ruby-version")"

brew unlink xz

for gem in "${GEMS[@]}"; do
  gem list -i "${gem}" &>/dev/null || gem install "${gem}"
done

gem ctags
for ruby in ~/.rubies/*/lib/ruby/; do
  pushd "${ruby}" &> /dev/null
    ctags -R ./*
  popd &> /dev/null
done

gem pristine --all

brew link xz

# clean
brew cleanup
