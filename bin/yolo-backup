#!/usr/bin/env bash
#
# A quick and dirty wrapper for restic (https://github.com/restic/restic)
#
# Usage:
#
# RESTIC_REPOSITORY=/backups/restic RESTIC_PASSWORD_FILE=/etc/restic/password RESTIC_EXCLUDE_FILE=/etc/restic/exclude $HOME/bin/yolo-backup
# RESTIC_REPOSITORY=gs:my-bucket/restic/$(hostname -f) GOOGLE_PROJECT_ID=1234 GOOGLE_APPLICATION_CREDENTIALS=/etc/restic/gs-secret-restic-key.json $HOME/bin/yolo-backup
#
# (c) 2017, Benjamin Dos Santos <benjamin.dossantos@gmail.com>
# https://github.com/bdossantos/dotfiles
#

set -o errexit
set -o pipefail
set -o nounset

DEBUG=${DEBUG:=0}
[[ $DEBUG -eq 1 ]] && set -o xtrace

PATH="${PATH}:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"
RESTIC_BACKUP_TARGET_DIRECTORY=${RESTIC_BACKUP_TARGET_DIRECTORY:='/'}
RESTIC_EXCLUDE_FILE=${RESTIC_EXCLUDE_FILE:='/dev/null'}
RESTIC_PASSWORD_FILE=${RESTIC_PASSWORD_FILE:='/dev/null'}
RESTIC_REPOSITORY=${RESTIC_REPOSITORY:-}
RESTIC_KEEP_LAST=${RESTIC_KEEP_LAST:=180}
SYSLOG=${SYSLOG=0}

export \
  PATH \
  RESTIC_PASSWORD_FILE \
  RESTIC_REPOSITORY

[[ $SYSLOG -eq 1 ]] && exec &> >(logger -s -t "$(basename "$0")")

function _restic_backup_files() {
  if [[ ! -r $RESTIC_EXCLUDE_FILE ]]; then
    >&2 echo "--> Exclude file list is not readable: ${RESTIC_EXCLUDE_FILE}"
    exit 1
  fi

  echo "--> Backup the following target: ${RESTIC_BACKUP_TARGET_DIRECTORY}"

  # don't forget to use `xattrs` flag when restoring
  tar \
    --exclude-from="$RESTIC_EXCLUDE_FILE" \
    --warning=no-file-changed \
    --warning=no-file-removed \
    --use-compress-program=pigz \
    -cpf - \
    / \
    | restic \
      --stdin \
      --stdin-filename='/system.tar.gz' \
      backup
}

function _restic_backup_mysql() {
  echo '--> Backup all mysql databases'

  if [[ -r /etc/mysql/debian.cnf ]]; then
    MYSQL_DEFAULT_FILES='/etc/mysql/debian.cnf'
  else
    MYSQL_DEFAULT_FILES="${HOME}/.my.cnf"
  fi

  mysqldump \
    --defaults-file="$MYSQL_DEFAULT_FILES" \
    --all-databases \
    --events \
    --quick \
    --routines \
    --single-transaction \
    --triggers \
    | pigz \
      --best \
      --to-stdout \
    | restic \
      --stdin \
      --stdin-filename="/mysql.sql.gz" \
      backup
}

function _restic_backup_postgresql() {
  su - postgres -c 'pg_dumpall' \
    | pigz \
      --best \
      --to-stdout \
    | restic \
      --stdin \
      --stdin-filename="/postgresql.sql.gz" \
      backup
}

function _restic_check() {
  restic check
}

function _restic_forget() {
  echo "--> restic forget keep last ${RESTIC_KEEP_LAST}"

  restic forget --keep-last "$RESTIC_KEEP_LAST" --prune
}

function _restic_init() {
  if [[ ! -r $RESTIC_PASSWORD_FILE ]]; then
    >&2 echo "--> Password file is not readable: ${RESTIC_PASSWORD_FILE}"
    exit 1
  fi

  echo "--> init restic repository to ${RESTIC_REPOSITORY}"

  restic version
  restic init || true
  restic unlock
}

function main() {
  cd /

  _restic_init

  if command -v mysqld; then
    _restic_backup_mysql
  fi

  if command -v pg_dumpall; then
    _restic_backup_postgresql
  fi

  _restic_backup_files

  _restic_forget

  _restic_check

  echo '--> Backup Finished!'
}

main
